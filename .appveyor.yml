# This configuration was influenced by googletest:
# https://github.com/google/googletest/blob/master/appveyor.yml

environment:
  matrix:
    - ARCH: x86
      GENERATOR: Visual Studio 14 2015
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
    - ARCH: x86_64
      GENERATOR: Visual Studio 14 2015 Win64
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
    - ARCH: x86
      GENERATOR: Visual Studio 15 2017
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
    - ARCH: x86_64
      GENERATOR: Visual Studio 15 2017 Win64
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017

configuration:
  - Debug
  - Release

install:
  - ps: |
      $ErrorActionPreference = "Stop"
      ${env:PATH} = "${env:PYTHON};${env:PYTHON}\Scripts;${env:PATH}"
      ls "${env:PYTHON}"
      ls "${env:PYTHON}\Scripts"
      where.exe python
      where.exe pip
      python -m pip --version
      pip --version
      python -m pip install --upgrade pip
      pip install --upgrade conan cupcake
      conan user
      conan --version
      conan remote add jfreeman https://api.bintray.com/conan/jfreeman/jfreeman
      conan remote list
      cmake --version
      cupcake --version

build_script:
  - ps: |
      $ErrorActionPreference = "Stop"
      md build
      cd build
      conan install `
        --build missing `
        --setting "arch=${env:ARCH}" `
        --setting "build_type=${env:CONFIGURATION}" `
        ..
      cmake `
        -G "${env:GENERATOR}" `
        -DCMAKE_CONFIGURATION_TYPES=${env:CONFIGURATION} `
        -DCMAKE_TOOLCHAIN_FILE=conan_paths.cmake `
        ..
      ${ncpus} = (python -c 'import multiprocessing as mp; print(mp.cpu_count())')
      ${env:CMAKE_BUILD_PARALLEL_LEVEL} = ${ncpus}
      cmake --build . --config "${env:CONFIGURATION}"

test_script:
  - ps: |
      $ErrorActionPreference = "Stop"
      ${ncpus} = (python -c 'import multiprocessing as mp; print(mp.cpu_count())')
      ${env:CTEST_PARALLEL_LEVEL} = ${ncpus}
      ctest --build-config ${env:CONFIGURATION} --verbose

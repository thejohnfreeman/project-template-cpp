name: Build, run, test, and install on Windows
on: [push, pull_request]

jobs:
  upstream:
    strategy:
      matrix:
        generator:
          - { name: Visual Studio 16 2019, multi: true }
        shared:
          - OFF
          - ON
        flavor:
          - Debug
          - Release
    runs-on: windows-2019
    env:
      generator: ${{ matrix.generator.name }}
      multi: ${{ matrix.generator.multi && 'true' || '' }}
      shared: ${{ matrix.shared }}
      flavor: ${{ matrix.flavor }}
      install_dir: C:\\
    steps:
      - name: checkout
        uses: actions/checkout@v3
      - name: read environment
        id: env
        run: |
          echo "::set-output name=PROGRAMDATA::%PROGRAMDATA%"
          echo "::set-output name=USERPROFILE::%USERPROFILE%"
      - name: install Make from cache
        id: cache-scoop
        uses: actions/cache@v2
        with:
            path: |
              ${{ steps.env.outputs.PROGRAMDATA }}\scoop
              ${{ steps.env.outputs.USERPROFILE }}\scoop
            key: ${{ secrets.CACHE_SCOOP }}
      - name: install Make with Scoop
        if: steps.cache-scoop.outputs.cache-hit != 'true'
        run: |
          iwr -useb get.scoop.sh | iex
          scoop install make
      - name: download Conan from cache
        id: cache-python
        uses: actions/cache@v2
        with:
            path: .cache-python
            key: ${{ secrets.CACHE_PYTHON }}
      - name: download Conan with pip
        if: steps.cache-python.outputs.cache-hit != 'true'
        run: pip download conan --dest .cache-python
      - name: install Conan
        run: pip install conan --no-index --find-links .cache-python
      - name: check environment
        run: |
          $env:PATH -split ';'
          python --version
          conan --version
          cmake --version
          make --version
          dir env:
      - name: configure
        working-directory: 00-upstream
        run: make configure
      - name: build
        working-directory: 00-upstream
        run: make build
      - name: built
        working-directory: 00-upstream
        run: make built
      - name: test
        working-directory: 00-upstream
        run: make test
      - name: install
        working-directory: 00-upstream
        run: make install
      - name: installed
        working-directory: 00-upstream
        run: make installed
      - name: path
        run: $env:PATH = "C:\\bin;$env:PATH"; executable

  find-package:
    needs: upstream
    strategy:
      matrix:
        generator:
          - { name: Visual Studio 16 2019, multi: true }
        shared:
          - OFF
          - ON
        flavor:
          - Debug
          - Release
    runs-on: windows-2019
    env:
      generator: ${{ matrix.generator.name }}
      multi: ${{ matrix.generator.multi && 'true' || '' }}
      shared: ${{ matrix.shared }}
      flavor: ${{ matrix.flavor }}
      install_dir: C:\\
    steps:
      - name: checkout
        uses: actions/checkout@v3
      - name: read environment
        id: env
        run: |
          echo "::set-output name=PROGRAMDATA::%PROGRAMDATA%"
          echo "::set-output name=USERPROFILE::%USERPROFILE%"
      - name: install Make from cache
        id: cache-scoop
        uses: actions/cache@v2
        with:
            path: |
              ${{ steps.env.outputs.PROGRAMDATA }}\scoop
              ${{ steps.env.outputs.USERPROFILE }}\scoop
            key: ${{ secrets.CACHE_SCOOP }}
      - name: install Make with Scoop
        if: steps.cache-scoop.outputs.cache-hit != 'true'
        run: |
          iwr -useb get.scoop.sh | iex
          scoop install make
      - name: download Conan from cache
        id: cache-python
        uses: actions/cache@v2
        with:
            path: .cache-python
            key: ${{ secrets.CACHE_PYTHON }}
      - name: download Conan with pip
        if: steps.cache-python.outputs.cache-hit != 'true'
        run: pip download conan --dest .cache-python
      - name: install Conan
        run: pip install conan --no-index --find-links .cache-python
      - name: check environment
        run: |
          $env:PATH -split ';'
          python --version
          conan --version
          cmake --version
          make --version
          dir env:
      - name: install
        working-directory: 00-upstream
        run: make install
      - name: configure
        working-directory: 01-find-package
        run: make configure
      - name: build
        working-directory: 01-find-package
        run: make build
      - name: built
        if: matrix.shared == 'OFF'
        working-directory: 01-find-package
        run: make built
      - name: install
        working-directory: 01-find-package
        run: make install
      - name: installed
        working-directory: 01-find-package
        run: make installed
      - name: path
        run: $env:PATH = "C:\\bin;$env:PATH"; executable
